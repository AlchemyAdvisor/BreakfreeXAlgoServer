stages:
  - build
  - publish

variables:
  IMAGE_NAME: "algoserver"

build:
  image: microsoft/dotnet:2.2-sdk
  stage: build
  script:
    - dotnet restore --configfile ./NuGet.Config
    - dotnet build
  #tags:
  #  - netcore

deploy-latest:
  stage: publish
  services:
    - docker:dind
  image: docker:latest
  only:
    - ci
    - develop
  script:
  - CONTAINER_IMAGE=$(echo "$CI_REGISTRY/$CI_PROJECT_PATH" | tr '[A-Z]' '[a-z]')
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  - docker pull $CONTAINER_IMAGE:latest || true
  - docker build --cache-from $CONTAINER_IMAGE:latest -t $IMAGE_NAME .
  - docker tag $IMAGE_NAME $CONTAINER_IMAGE:latest
  - docker push $CONTAINER_IMAGE:latest
  - docker logout
  - apk update && apk add curl jq
  - curl -LO https://stedolan.github.io/jq/download/linux64/jq
  - chmod u+x jq && mv jq /bin/jq
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.19.2/bin/linux/amd64/kubectl
  - chmod u+x kubectl && mv kubectl /bin/kubectl
  - LATEST_DIGEST=$(curl -s --header "PRIVATE-TOKEN:$PRIVATE_TOKEN" "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/registry/repositories/1222029/tags/latest" | jq -r '.digest')
  - echo "Image '$CONTAINER_IMAGE@$LATEST_DIGEST'"
  - kubectl config set-cluster k8s --server=${K8S_SERVER}
  - kubectl config set clusters.k8s.certificate-authority-data ${K8S_CERTIFICATE_AUTHORITY_DATA}
  - kubectl config set-credentials ${K8S_USER} --token="${K8S_USER_TOKEN}"
  - kubectl config set-context k8s-stage --cluster=k8s --user=${K8S_USER}
  - kubectl config use-context k8s-stage
  - kubectl config current-context
  - kubectl set image deployment/algoserver algoserver=$CONTAINER_IMAGE@$LATEST_DIGEST --namespace staging
  - kubectl set image deployment/algoscanner algoscanner=$CONTAINER_IMAGE@$LATEST_DIGEST --namespace staging
  - kubectl get pods -n staging
  # tags: 
  # - docker

deploy-release:
  stage: publish
  when: manual
  services:
    - docker:dind
  image: docker:latest
  # before_script:
  # - apk add --no-cache curl jq python py-pip
  # - pip install awscli
  # - apk update && apk add git
  # - TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
  # - MINORVERSION=$(git rev-list --all --count)
  # - MAJORVERSION=${TAG:-0.0}
  # - VERSION=$MAJORVERSION.$MINORVERSION
  only:
    - ci
    - master
  script:
  - CONTAINER_IMAGE=$(echo "$CI_REGISTRY/$CI_PROJECT_PATH" | tr '[A-Z]' '[a-z]')
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  - docker pull $CONTAINER_IMAGE:stable || true
  - docker build --cache-from $CONTAINER_IMAGE:stable -t $IMAGE_NAME .
  - docker tag $IMAGE_NAME $CONTAINER_IMAGE:stable
  - docker push $CONTAINER_IMAGE:stable
  - docker logout
  #- $(aws ecr get-login --no-include-email --region ap-southeast-1)
  #- docker tag $IMAGE_NAME $AWS_REGISTRY/$IMAGE_NAME:$VERSION
  #- docker tag $IMAGE_NAME $AWS_REGISTRY/$IMAGE_NAME:stable
  #- docker push $AWS_REGISTRY/$IMAGE_NAME:$VERSION
  #- docker push $AWS_REGISTRY/$IMAGE_NAME:stable
  #- docker logout
  #tags:
  #  - docker
